<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RealMe</title>
  <link rel="icon" href="./src/icon/icon.png" type="image/png" />
  <meta name="theme-color" content="#1F1F1F" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="./src/icon/icon.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="./src/styles/base.css" />
  <link rel="stylesheet" href="./src/styles/sobre.css" />
  <link rel="stylesheet" href="./src/styles/amigos.css" />
  <link rel="stylesheet" href="./src/styles/media-queries.css" />
  <link rel="stylesheet" href="./src/styles/navbars.css" />
  <link rel="stylesheet" href="./src/styles/search.css" />
  <link rel="stylesheet" href="./src/styles/post-modal.css" />
  <link rel="stylesheet" href="./src/styles/search.css" />
</head>
<body>

  <div class="glass-overlay"></div>

  <!-- Navbar -->
  <nav>
    <div class="logo_area">
      <div class="logo">RealMe</div>
    </div>
    <div class="search-area">
  <div class="search-box">
    <button><i class="fas fa-search"></i></button>
    <input type="text" id="searchInput" placeholder="Buscar" autocomplete="off" />
  </div>
    </div>
    <div class="last-update-area">
      <div class="last-update">
        <p>Novidades!</p>
      </div>
    </div>
    <div class="marquee-container">
      <div class="marquee"></div>
    </div>
  </nav>

   <!-- Sidebar -->
  <aside class="sidebar">
    <a href="feed.html"><i class="fas fa-home"></i> In√≠cio</a>
    <a href="acharamigos.html"><i class="fas fa-user-friends"></i> Achar Amigos</a>
    <a href="direct.html"><i class="fas fa-comments"></i> Mensagens</a>
    <a href="nt.html"><i class="fas fa-bell"></i> Notifica√ß√µes</a>
    <a href="#" class="postmodal"><i class="fas fa-plus-square"></i> Criar</a>
    <a href="#" id="linkPerfilSidebar"><i class="fas fa-user"></i> Perfil</a>
    <div class="more-menu" id="moreMenu">
      <a href="#" class="more-toggle" id="moreToggle">
        <i class="fa-solid fa-bars"></i>
        Mais
      </a>
      <div class="floating-menu" id="floatingMenu">
        <a href="config.html"><i class="fas fa-cog"></i> Configura√ß√µes</a>
        <a href="invites.html"><i class="fa-solid fa-user-plus"></i> Convites</a>
        <a href="como-usar.html"><i class="fa-solid fa-book-open"></i> Como Usar</a>
        <a href="sobre.html"><i class="fas fa-question-circle"></i> Sobre</a>
        <a href="#" id="btnSair"><i class="fas fa-sign-out-alt"></i> Sair</a>
      </div>
    </div>
  </aside>
  <ul id="searchResults"></ul>

  <div class="friends-container">
        <div class="friends-header">
            <h1>Pessoas parecidas com voc√™!</h1>
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="carousel">Cards</button>
                <button class="toggle-btn" data-view="grid">Grid</button>
            </div>
        </div>

        <!-- VIEW GRID (Original) -->
        <div class="grid-view" id="gridView">
            <div class="friends-list">
                <a class="user" href="#" data-username="afliccoess">
                    <img src="https://lastfm.freetls.fastly.net/i/u/avatar170s/3c04e79db06c605e5de3897555a9a34e.png" alt="Vini demarco">
                    <div class="user-name">
                        <div class="profile-name">
                            <p>Vini demarco</p>
                        </div>
                        <div class="profile-username">
                            <p>@afliccoess</p>
                        </div>
                    </div>
                </a>
                <a class="user" href="#" data-username="vampirinhaz7">
                    <img src="https://cdn.pfps.gg/pfps/1869-goth-egirl-27.png" alt="Mari">
                    <div class="user-name">
                        <div class="profile-name">
                            <p>ñ§çñ§åñ§ç Mari Saverio</p>
                        </div>
                        <div class="profile-username">
                            <p>@vampirinhaz7</p>
                        </div>
                    </div>
                </a>
                <a class="user" href="#" data-username="maxgfortes">
                    <img src="https://i.pinimg.com/736x/d6/fc/2a/d6fc2ab598fdc5ffee863bd5835746c8.jpg" alt="Max">
                    <div class="user-name">
                        <div class="profile-name">
                            <p>maxgfortes</p>
                        </div>
                        <div class="profile-username">
                            <p>@maxgfortes</p>
                        </div>
                    </div>
                </a>
                <a class="user" href="#" data-username="maxine">
                    <img src="https://i.pinimg.com/736x/0e/10/35/0e1035c960796eccbc18608793cfa3e9.jpg" alt="Maxine">
                    <div class="user-name">
                        <div class="profile-name">
                            <p>‚ãÜÀöÔΩ°‚ãÜ‡≠®‚úß‡≠ßÀö ùë¥ùíÇùíôùíäùíèùíÜ Àö‡≠®‚úß‡≠ß‚ãÜÔΩ°Àö‚ãÜ</p>
                        </div>
                        <div class="profile-username">
                            <p>@maxine</p>
                        </div>
                    </div>
                </a>
                <a class="user" href="#" data-username="davix">
                    <img src="https://i.pinimg.com/736x/12/d3/dd/12d3dd5ac7a32f43cf867161cb95774f.jpg" alt="David">
                    <div class="user-name">
                        <div class="profile-name">
                            <p>warrsex</p>
                        </div>
                        <div class="profile-username">
                            <p>@davix</p>
                        </div>
                    </div>
                </a>
                <a class="user" href="#" data-username="haspkey">
                    <img src="https://i.postimg.cc/CK3qy1w5/image.png" alt="Haspkey">
                    <div class="user-name">
                        <div class="profile-name">
                            <p>haspkey</p>
                        </div>
                        <div class="profile-username">
                            <p>@haspkey</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>


  <!-- VIEW CAROUSEL (Novo) -->
        <div class="carousel-view active" id="carouselView">
            <div class="carousel-container">
                <div class="cards-wrapper" id="cardsWrapper">
                    <!-- Cards ser√£o gerados dinamicamente -->
                </div>
            </div>
            <div class="carousel-controls">
                <button class="nav-btn" id="prevBtn">‚Äπ</button>
                <div class="indicators" id="indicators"></div>
                <button class="nav-btn" id="nextBtn">‚Ä∫</button>
            </div>
        </div>
    </div>

<aside class="option-bar">
  <h1>Preferencias</h1>
  <div class="options">
      <!-- Checkbox ‚ÄúIgual a mim‚Äù -->
      <div class="lm">
        <p>Igual a mim</p>
        <label class="switch">
          <input type="checkbox" id="igualAMim">
          <span class="slider"></span>
        </label>
      </div>
  <div class="filtros">
    <div class="estilo">
      <p>Estilo</p>
      <input class="estilo" type="text" placeholder="gotico, alternativo, sk8 archive...">
    </div>

    <div class="estilo">
      <p>Personalidade</p>
      <input class="estilo" type="text" placeholder="extrovertido, introvertido...">
    </div>

    <div class="estilo">
      <p>Medos</p>
      <input class="estilo" type="text" placeholder="Medo de Acabar Sozinho...">
    </div>

    <div class="estilo">
      <p>Sonhos e Desejos</p>
      <input class="estilo" type="text" placeholder="Conex√£o real, Amor, Dinheiro...">
    </div>

    <div class="estilo">
      <p>Musicas</p>
      <input class="estilo" type="text" placeholder="Rock, Grunge, Pop, Alt, Indie...">
    </div>

    <div class="estilo">
      <p>Personagens</p>
      <input class="estilo" type="text" placeholder="Jesse Pinkman, Cassie, Marla...">
    </div>

    <div class="estilo">
      <p>localiza√ß√£o</p>
      <input class="estilo" type="text" placeholder="S√£o Paulo, Porto Alegre...">
    </div>

    <div class="estilo">
      <p>Hobbies</p>
      <input class="estilo" type="text" placeholder="Esportes, Pintura, Musica...">
    </div>

    <div class="selecoes">
      <p>Genero</p>
      <select id="genero">
        <option value="">Qualquer</option>
        <option value="Masculino">Masculino</option>
        <option value="Feminino">Feminino</option>
        <option value="binario">N√£o Binario</option>
      </select>
    </div>

    <div class="selecoes">
      <p>Estado Civil</p>
      <select id="genero">
        <option value="">Namorando</option>
        <option value="Masculino">Solteiro</option>
        <option value="Feminino">Casado</option>
        <option value="binario">Em compromisso</option>
        <option value="binario">Viuvo</option>
      </select>
    </div>

    <div class="selecoes">
      <p>MBTI</p>
      <select id="genero">
        <option value="">ISTJ</option>
        <option value="Masculino">ISFJ</option>
        <option value="Feminino">INFJ</option>
        <option value="binario">INTJ</option>
        <option value="binario">ISTP</option>
        <option value="binario">ISFP</option>
        <option value="binario">INTJ</option>
        <option value="binario">INFP</option>
        <option value="binario">INTP</option>
        <option value="binario">ESTP</option>
        <option value="binario">ESFP</option>
        <option value="binario">ENFP</option>
        <option value="binario">ENTP</option>
        <option value="binario">ESTJ</option>
        <option value="binario">ESFJ</option>
        <option value="binario">ENFJ</option>
        <option value="binario">ENTJ</option>
      </select>
    </div>    
    <div class="age">
      <div class="age-range">
        <p>Idade minima</p>
        <input class="age-input" type="number" id="idade-min" min="13" max="78" value="14">
      </div>
      <div class="age-range">
        <p>Idade Maxima</p>
        <input class="age-input" type="number" id="idade-max" min="13" max="78" step="1" value="17">
      </div>
    </div>

  </div>
</div>

  <!-- Bot√£o fixo -->
  <button class="search-btn" type="submit" form="search-form">Buscar!</button>
  </div>
</aside>
</div>

<!-- Modal Post Container -->
    <div id="postmodal" class="modal-post-container">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Criar Novo <span>Post</span>!</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-greeting">
              <p>Como est√° sendo o seu dia? Fa√ßa um post sobre isso.</p>
            </div>
            <div class="modal-body">
                <input type="text" class="textarea-post" placeholder="Escreva um pensamento..." maxlength="100">
                <button class="btn-sending">Enviar!</button>
            </div>
        </div>
    </div>

<script src="./src/js/postmodal.js"></script>
<script src="./src/js/more.js"></script>


<script>
        // Dados dos usu√°rios
        const users = [
            {
                name: "Vini demarco",
                username: "@afliccoess",
                image: "https://lastfm.freetls.fastly.net/i/u/avatar170s/3c04e79db06c605e5de3897555a9a34e.png",
                profile: "PF.html?username=afliccoess"
            },
            {
                name: "ñ§çñ§åñ§ç Mari Saverio",
                username: "@vampirinhaz7",
                image: "https://cdn.pfps.gg/pfps/1869-goth-egirl-27.png",
                profile: "PF.html?username=vampirinhaz7"
            },
            {
                name: "maxgfortes",
                username: "@maxgfortes",
                image: "https://i.pinimg.com/736x/d6/fc/2a/d6fc2ab598fdc5ffee863bd5835746c8.jpg",
                profile: "PF.html?username=maxgfortes"
            },
            {
                name: "‚ãÜÀöÔΩ°‚ãÜ‡≠®‚úß‡≠ßÀö ùë¥ùíÇùíôùíäùíèùíÜ Àö‡≠®‚úß‡≠ß‚ãÜÔΩ°Àö‚ãÜ",
                username: "@maxine",
                image: "https://i.pinimg.com/736x/0e/10/35/0e1035c960796eccbc18608793cfa3e9.jpg",
                profile: "PF.html?username=maxine"
            },
            {
                name: "warrsex",
                username: "@davix",
                image: "https://i.pinimg.com/736x/12/d3/dd/12d3dd5ac7a32f43cf867161cb95774f.jpg",
                profile: "PF.html?username=davix"
            },
            {
                name: "haspkey",
                username: "@haspkey",
                image: "https://i.postimg.cc/CK3qy1w5/image.png",
                profile: "PF.html?username=haspkey"
            },
            {
                name: "haspkey",
                username: "@haspkey",
                image: "https://i.postimg.cc/CK3qy1w5/image.png",
                profile: "PF.html?username=haspkey"
            },
            {
                name: "haspkey",
                username: "@haspkey",
                image: "https://i.postimg.cc/CK3qy1w5/image.png",
                profile: "PF.html?username=haspkey"
            },
            {
                name: "haspkey",
                username: "@haspkey",
                image: "https://i.postimg.cc/CK3qy1w5/image.png",
                profile: "PF.html?username=haspkey"
            }
        ];

        class FriendsCarousel {
            constructor() {
                this.currentIndex = 0;
                this.users = users;
                this.cardsWrapper = document.getElementById('cardsWrapper');
                this.indicators = document.getElementById('indicators');
                this.isTransitioning = false;
                
                this.init();
            }

            init() {
                this.createCards();
                this.createIndicators();
                this.bindEvents();
                this.updateDisplay();
            }

            createCards() {
                this.cardsWrapper.innerHTML = '';
                this.users.forEach((user, index) => {
                    const card = document.createElement('div');
                    card.className = 'friend-card';
                    card.innerHTML = `
                        <div class="card-content">
                            <img src="${user.image}" alt="${user.name}" class="card-image">
                            <div class="card-info">
                                <div class="card-name">${user.name}</div>
                                <div class="card-username">${user.username}</div>
                            </div>
                            <a href="${user.profile}" class="view-profile-btn"><p>Ver Perfil</p>
                            </a>
                        </div>
                    `;
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.view-profile-btn')) {
                            this.goToSlide(index);
                        }
                    });
                    this.cardsWrapper.appendChild(card);
                });
            }

            createIndicators() {
                this.indicators.innerHTML = '';
                this.users.forEach((_, index) => {
                    const indicator = document.createElement('div');
                    indicator.className = 'indicator';
                    if (index === 0) indicator.classList.add('active');
                    indicator.addEventListener('click', () => {
                        this.goToSlide(index);
                    });
                    this.indicators.appendChild(indicator);
                });
            }

            updateDisplay() {
                const cards = this.cardsWrapper.children;
                const totalCards = cards.length;

                Array.from(cards).forEach(card => {
                    card.classList.remove('center', 'left', 'right', 'far-left', 'far-right', 'hidden');
                });

                Array.from(cards).forEach((card, index) => {
                    const relativePos = this.getRelativePosition(index, this.currentIndex, totalCards);
                    switch (relativePos) {
                        case 0: card.classList.add('center'); break;
                        case 1: card.classList.add('right'); break;
                        case -1: card.classList.add('left'); break;
                        case 2: card.classList.add('far-right'); break;
                        case -2: card.classList.add('far-left'); break;
                        default: card.classList.add('hidden'); break;
                    }
                });

                // Corrige as bolinhas para sempre mostrar todas e ativar a correta
                const indicatorElements = this.indicators.children;
                Array.from(indicatorElements).forEach((indicator, index) => {
                    indicator.classList.toggle('active', index === this.currentIndex);
                });
            }

            // Corrige o c√°lculo para sempre ser infinito
            getRelativePosition(cardIndex, currentIndex, totalCards) {
                let diff = cardIndex - currentIndex;
                // Mant√©m o carrossel infinito sem pular bolinhas
                if (diff > totalCards / 2) {
                    diff -= totalCards;
                } else if (diff < -totalCards / 2) {
                    diff += totalCards;
                }
                return diff;
            }

            goToSlide(index) {
                if (this.isTransitioning || index === this.currentIndex) return;
                this.isTransitioning = true;
                this.currentIndex = index;
                this.updateDisplay();
                setTimeout(() => {
                    this.isTransitioning = false;
                }, 400);
            }

            next() {
                this.currentIndex = (this.currentIndex + 1) % this.users.length;
                this.updateDisplay();
            }

            prev() {
                this.currentIndex = (this.currentIndex - 1 + this.users.length) % this.users.length;
                this.updateDisplay();
            }

            bindEvents() {
                document.getElementById('nextBtn').addEventListener('click', () => this.next());
                document.getElementById('prevBtn').addEventListener('click', () => this.prev());
                document.addEventListener('keydown', (e) => {
                    if (document.getElementById('carouselView').classList.contains('active')) {
                        if (e.key === 'ArrowRight') this.next();
                        if (e.key === 'ArrowLeft') this.prev();
                    }
                });
            }
        }

        // Toggle entre views
        class ViewToggle {
            constructor() {
                this.currentView = 'carousel';
                this.init();
            }

            init() {
                const toggleButtons = document.querySelectorAll('.toggle-btn');
                toggleButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const viewType = btn.dataset.view;
                        this.switchView(viewType);
                        toggleButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
            }

            switchView(viewType) {
                const gridView = document.getElementById('gridView');
                const carouselView = document.getElementById('carouselView');
                if (viewType === 'grid') {
                    gridView.classList.add('active');
                    carouselView.classList.remove('active');
                    this.currentView = 'grid';
                } else {
                    carouselView.classList.add('active');
                    gridView.classList.remove('active');
                    this.currentView = 'carousel';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const carousel = new FriendsCarousel();
            const viewToggle = new ViewToggle();
            console.log('Sistema de amigos inicializado!');
        });
</script>
<script type="module">
// ===============================
//  acharAmigos.js
//  Busca usu√°rios semelhantes no Firestore por pontos de similaridade
// ===============================

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB2N41DiH0-Wjdos19dizlWSKOlkpPuOWs",
  authDomain: "ifriendmatch.firebaseapp.com",
  projectId: "ifriendmatch",
  storageBucket: "ifriendmatch.appspot.com",
  messagingSenderId: "306331636603",
  appId: "1:306331636603:web:c0ae0bd22501803995e3de",
  measurementId: "G-D96BEW6RC3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserId = null;
onAuthStateChanged(auth, (user) => {
  if (user) currentUserId = user.uid;
});

const btnBuscar = document.querySelector('.search-btn');
const switchIgualAMim = document.getElementById('igualAMim');
const filtrosInputs = document.querySelectorAll('.filtros input, .filtros select');
const cardsWrapper = document.getElementById('cardsWrapper');
const friendsList = document.querySelector('.friends-list'); // grid view

function normalizar(str) {
  return (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

if (btnBuscar) btnBuscar.addEventListener('click', buscarUsuariosSemelhantes);
if (switchIgualAMim) switchIgualAMim.addEventListener('change', alternarIgualAMim);

async function alternarIgualAMim() {
  if (switchIgualAMim.checked) {
    filtrosInputs.forEach(el => {
      el.disabled = true;
      el.classList.add('cinza');
    });
    await preencherComDadosDoUsuarioAtual();
  } else {
    filtrosInputs.forEach(el => {
      el.disabled = false;
      el.classList.remove('cinza');
      el.value = '';
    });
  }
}

async function preencherComDadosDoUsuarioAtual() {
  if (!currentUserId) return;
  const userRef = doc(db, "users", currentUserId);
  const userSnap = await getDoc(userRef);
  const mediaRef = doc(db, "users", currentUserId, "user-infos", "user-media");
  const aboutRef = doc(db, "users", currentUserId, "user-infos", "about");
  const likesRef = doc(db, "users", currentUserId, "user-infos", "likes");
  const [mediaSnap, aboutSnap, likesSnap] = await Promise.all([
    getDoc(mediaRef), getDoc(aboutRef), getDoc(likesRef)
  ]);
  const userData = userSnap.exists() ? userSnap.data() : {};
  const media = mediaSnap.exists() ? mediaSnap.data() : {};
  const about = aboutSnap.exists() ? aboutSnap.data() : {};
  const likes = likesSnap.exists() ? likesSnap.data() : {};

  filtrosInputs.forEach(input => {
    const label = input.previousElementSibling?.textContent?.toLowerCase() || '';
    if (label.includes('estilo')) input.value = about.styles || '';
    if (label.includes('personalidade')) input.value = about.personality || '';
    if (label.includes('medo')) input.value = about.fears || '';
    if (label.includes('sonho')) input.value = about.dreams || '';
    if (label.includes('musica')) input.value = likes.music || '';
    if (label.includes('personagem')) input.value = likes.characters || '';
    if (label.includes('hobbies')) input.value = likes.hobbies || '';
    if (label.includes('local')) input.value = userData.location || userData.localizacao || '';
    if (label.includes('genero')) input.value = userData.gender || '';
    if (label.includes('estado civil')) input.value = userData.maritalStatus || '';
    if (label.includes('mbti')) input.value = userData.MBTI || userData.mbti || '';
    if (input.classList.contains('age-input')) {
      if (userData.nascimento) {
        const nasc = new Date(userData.nascimento);
        const hoje = new Date();
        const idade = hoje.getFullYear() - nasc.getFullYear();
        input.value = idade;
      }
    }
  });
}

function mostrarLoading() {
  if (cardsWrapper) {
    cardsWrapper.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner-center">
          <div class="spinner"></div>
          <p>Carregando pessoas...</p>
        </div>
      </div>
    `;
  }
  if (friendsList) {
    friendsList.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner-center">
          <div class="spinner"></div>
          <p>Carregando pessoas...</p>
        </div>
      </div>
    `;
  }
}

function removerLoading() {
  if (cardsWrapper) {
    const spinner = cardsWrapper.querySelector('.loading-spinner');
    if (spinner) spinner.remove();
  }
  if (friendsList) {
    const spinner = friendsList.querySelector('.loading-spinner');
    if (spinner) spinner.remove();
  }
}

let cacheUltimosUsuarios = [];
let carouselInstance = null;

function renderizarResultados(resultados) {
  if (!cardsWrapper) return;
  cardsWrapper.innerHTML = '';
  if (!resultados.length) {
    cardsWrapper.innerHTML = '<p>Nenhum usu√°rio parecido encontrado.</p>';
    return;
  }

  // Remove duplicados pelo id
  const vistos = new Set();
  const resultadosUnicos = resultados.filter(u => {
    if (vistos.has(u.id)) return false;
    vistos.add(u.id);
    return true;
  });

  resultadosUnicos.forEach(u => {
    const card = document.createElement('div');
    card.className = 'friend-card';
    card.innerHTML = `
      <div class="card-content">
        <img src="${u.userphoto}" alt="${u.displayname}" class="card-image">
        <div class="card-info">
          <div class="card-name">${u.displayname}</div>
          <div class="card-username">@${u.username}</div>
        </div>
        <a href="PF.html?userid=${u.id}" class="view-profile-btn">
          <p>Ver Perfil</p>
        </a>
        <p class="similarity">Compatibilidade: ${(u.score * 100).toFixed(0)}%</p>
      </div>
    `;
    cardsWrapper.appendChild(card);
  });

  // Salva no cache
  cacheUltimosUsuarios = resultadosUnicos.slice(0, 20);
  localStorage.setItem('ultimosUsuarios', JSON.stringify(cacheUltimosUsuarios));

  // Atualiza o carrossel com os dados buscados
  if (carouselInstance) {
    const users = resultadosUnicos.map(u => ({
      name: u.displayname,
      username: '@' + u.username,
      image: u.userphoto,
      profile: `PF.html?userid=${u.id}`
    }));
    carouselInstance.setUsers(users);
  }
}

function renderizarGrid(resultados) {
  if (!friendsList) return;
  friendsList.innerHTML = '';
  if (!resultados.length) {
    friendsList.innerHTML = '<p>Nenhum usu√°rio parecido encontrado.</p>';
    return;
  }

  // Remove duplicados pelo id
  const vistos = new Set();
  const resultadosUnicos = resultados.filter(u => {
    if (vistos.has(u.id)) return false;
    vistos.add(u.id);
    return true;
  });

  resultadosUnicos.forEach(u => {
    const userEl = document.createElement('a');
    userEl.className = 'user';
    userEl.href = `PF.html?userid=${u.id}`;
    userEl.setAttribute('data-username', u.username);
    userEl.innerHTML = `
      <img src="${u.userphoto}" alt="${u.displayname}">
      <div class="user-name">
        <div class="profile-name">
          <p>${u.displayname}</p>
        </div>
        <div class="profile-username">
          <p>@${u.username}</p>
        </div>
        <div style="font-size:12px;color:#4e8cff;">Compatibilidade: ${(u.score * 100).toFixed(0)}%</div>
      </div>
    `;
    friendsList.appendChild(userEl);
  });

  // Salva no cache
  cacheUltimosUsuarios = resultadosUnicos.slice(0, 20);
  localStorage.setItem('ultimosUsuarios', JSON.stringify(cacheUltimosUsuarios));
}

// Exibe cache ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', () => {
  carouselInstance = new FriendsCarousel();
  carouselInstance.bindEvents();
  const cache = localStorage.getItem('ultimosUsuarios');
  if (cache) {
    const usuarios = JSON.parse(cache);
    renderizarResultados(usuarios);
    renderizarGrid(usuarios);
  }
  const viewToggle = new ViewToggle();
  console.log('Sistema de amigos inicializado!');
});

async function buscarUsuariosSemelhantes() {
  mostrarLoading();
  const filtros = coletarFiltros();
  const usersRef = collection(db, 'users');
  const snapshot = await getDocs(usersRef);
  const resultados = [];

  for (const docSnap of snapshot.docs) {
    const userId = docSnap.id;
    if (userId === currentUserId) continue;

    const userData = docSnap.data();
    const mediaRef = doc(db, "users", userId, "user-infos", "user-media");
    const aboutRef = doc(db, "users", userId, "user-infos", "about");
    const likesRef = doc(db, "users", userId, "user-infos", "likes");
    const [mediaSnap, aboutSnap, likesSnap] = await Promise.all([
      getDoc(mediaRef), getDoc(aboutRef), getDoc(likesRef)
    ]);
    const media = mediaSnap.exists() ? mediaSnap.data() : {};
    const about = aboutSnap.exists() ? aboutSnap.data() : {};
    const likes = likesSnap.exists() ? likesSnap.data() : {};

    // Junta todos os dados relevantes
    const perfil = {
      ...userData,
      ...media,
      ...about,
      ...likes
    };

    // Calcula idade
    let idade = null;
    if (perfil.nascimento) {
      const nasc = new Date(perfil.nascimento);
      const hoje = new Date();
      idade = hoje.getFullYear() - nasc.getFullYear();
    }

    // Calcula score de similaridade
    const score = calcularSimilaridadeCampos(perfil, filtros, idade);

    if (score > 0) {
      resultados.push({
        id: userId,
        displayname: perfil.displayname || perfil.username || perfil.name || 'Usu√°rio',
        username: perfil.username || '',
        userphoto: perfil.userphoto || './src/icon/default.jpg',
        score
      });
      // Mostra incremental
      resultados.sort((a, b) => b.score - a.score);
      renderizarResultados(resultados);
      renderizarGrid(resultados);
    }
  }

  removerLoading();
  resultados.sort((a, b) => b.score - a.score);
  renderizarResultados(resultados);
  renderizarGrid(resultados);
  if (!resultados.length) {
    if (cardsWrapper) cardsWrapper.innerHTML = '<p>Nenhum usu√°rio parecido encontrado.</p>';
    if (friendsList) friendsList.innerHTML = '<p>Nenhum usu√°rio parecido encontrado.</p>';
  }
}

function coletarFiltros() {
  const filtros = {};
  filtrosInputs.forEach(el => {
    const label = el.previousElementSibling?.textContent?.trim().toLowerCase() || el.id;
    filtros[label] = el.value.trim().toLowerCase();
  });
  filtros['idade-minima'] = document.getElementById('idade-min')?.value || '';
  filtros['idade-maxima'] = document.getElementById('idade-max')?.value || '';
  return filtros;
}

function calcularSimilaridadeCampos(perfil, filtros, idade) {
  let score = 0;
  let campos = 0;

  // Permite m√∫ltiplos termos separados por v√≠rgula ou espa√ßo
  function termosFiltro(valor) {
    if (!valor) return [];
    return valor.split(',').map(t => t.trim()).filter(Boolean).flatMap(t => t.split(' ')).filter(Boolean);
  }

  // Estilo
  if (filtros['estilo']) {
    const termos = termosFiltro(filtros['estilo']);
    const campo = normalizar(perfil.styles || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Personalidade
  if (filtros['personalidade']) {
    const termos = termosFiltro(filtros['personalidade']);
    const campo = normalizar(perfil.personality || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Medos
  if (filtros['medos']) {
    const termos = termosFiltro(filtros['medos']);
    const campo = normalizar(perfil.fears || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Sonhos
  if (filtros['sonhos e desejos']) {
    const termos = termosFiltro(filtros['sonhos e desejos']);
    const campo = normalizar(perfil.dreams || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Musicas
  if (filtros['musicas']) {
    const termos = termosFiltro(filtros['musicas']);
    const campo = normalizar(perfil.music || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Personagens
  if (filtros['personagens']) {
    const termos = termosFiltro(filtros['personagens']);
    const campo = normalizar(perfil.characters || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Hobbies
  if (filtros['hobbies']) {
    const termos = termosFiltro(filtros['hobbies']);
    const campo = normalizar(perfil.hobbies || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Localiza√ß√£o
  if (filtros['localiza√ß√£o']) {
    const termos = termosFiltro(filtros['localiza√ß√£o']);
    const campo = normalizar(perfil.location || perfil.localizacao || '');
    if (termos.some(t => campo.includes(normalizar(t)))) score += 2;
    campos++;
  }
  // Genero
  if (filtros['genero']) {
    const termos = termosFiltro(filtros['genero']);
    const campo = normalizar(perfil.gender || '');
    if (termos.some(t => campo === normalizar(t))) score += 2;
    campos++;
  }
  // Estado Civil
  if (filtros['estado civil']) {
    const termos = termosFiltro(filtros['estado civil']);
    const campo = normalizar(perfil.maritalStatus || '');
    if (termos.some(t => campo === normalizar(t))) score += 2;
    campos++;
  }
  // MBTI
  if (filtros['mbti']) {
    const termos = termosFiltro(filtros['mbti']);
    const campo = normalizar(perfil.MBTI || perfil.mbti || '');
    if (termos.some(t => campo === normalizar(t))) score += 2;
    campos++;
  }
  // Idade
  if (filtros['idade-minima'] || filtros['idade-maxima']) {
    const min = parseInt(filtros['idade-minima']) || 0;
    const max = parseInt(filtros['idade-maxima']) || 200;
    if (idade !== null && idade >= min && idade <= max) score += 2;
    campos++;
  }

  // Busca por palavras-chave em todos os textos do usu√°rio
  const palavrasFiltro = Object.values(filtros)
    .filter(Boolean)
    .flatMap(termosFiltro)
    .map(normalizar);

  const textoUsuario = [
    perfil.bio || '',
    perfil.displayname || '',
    perfil.username || '',
    perfil.name || '',
    perfil.surname || '',
    perfil.music || '',
    perfil.hobbies || '',
    perfil.characters || '',
    perfil.dreams || '',
    perfil.fears || '',
    perfil.location || '',
    perfil.localizacao || '',
    perfil.tags || '',
    perfil.books || '',
    perfil.foods || '',
    perfil.games || '',
    perfil.movies || '',
    perfil.overview || '',
    perfil.others || ''
  ].join(' ').toLowerCase();

  palavrasFiltro.forEach(palavra => {
    if (textoUsuario.includes(palavra)) score += 1;
  });

  return campos ? score / campos : 0;
}

// Carrossel din√¢mico
class FriendsCarousel {
    constructor() {
        this.currentIndex = 0;
        this.users = [];
        this.cardsWrapper = document.getElementById('cardsWrapper');
        this.indicators = document.getElementById('indicators');
        this.isTransitioning = false;
    }

    setUsers(newUsers) {
        // Remove duplicados pelo profile (url) ou username
        const vistos = new Set();
        this.users = newUsers.filter(u => {
            const key = u.profile || u.username;
            if (vistos.has(key)) return false;
            vistos.add(key);
            return true;
        });
        this.currentIndex = 0;
        this.createCards();
        this.createIndicators();
        this.updateDisplay();
    }

    createCards() {
        this.cardsWrapper.innerHTML = '';
        this.users.forEach((user, index) => {
            const card = document.createElement('div');
            card.className = 'friend-card';
            card.innerHTML = `
                <div class="card-content">
                    <img src="${user.image}" alt="${user.name}" class="card-image">
                    <div class="card-info">
                        <div class="card-name">${user.name}</div>
                        <div class="card-username">${user.username}</div>
                    </div>
                    <a href="${user.profile}" class="view-profile-btn"><p>Ver Perfil</p>
                    </a>
                </div>
            `;
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.view-profile-btn')) {
                    this.goToSlide(index);
                }
            });
            this.cardsWrapper.appendChild(card);
        });
    }

    createIndicators() {
        this.indicators.innerHTML = '';
        this.users.forEach((_, index) => {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            if (index === 0) indicator.classList.add('active');
            indicator.addEventListener('click', () => {
                this.goToSlide(index);
            });
            this.indicators.appendChild(indicator);
        });
    }

    updateDisplay() {
        const cards = this.cardsWrapper.children;
        const totalCards = cards.length;

        Array.from(cards).forEach(card => {
            card.classList.remove('center', 'left', 'right', 'far-left', 'far-right', 'hidden');
        });

        Array.from(cards).forEach((card, index) => {
            const relativePos = this.getRelativePosition(index, this.currentIndex, totalCards);
            switch (relativePos) {
                case 0: card.classList.add('center'); break;
                case 1: card.classList.add('right'); break;
                case -1: card.classList.add('left'); break;
                case 2: card.classList.add('far-right'); break;
                case -2: card.classList.add('far-left'); break;
                default: card.classList.add('hidden'); break;
            }
        });

        // Corrige as bolinhas para sempre mostrar todas e ativar a correta
        const indicatorElements = this.indicators.children;
        Array.from(indicatorElements).forEach((indicator, index) => {
            indicator.classList.toggle('active', index === this.currentIndex);
        });
    }

    getRelativePosition(cardIndex, currentIndex, totalCards) {
        let diff = cardIndex - currentIndex;
        if (diff > totalCards / 2) {
            diff -= totalCards;
        } else if (diff < -totalCards / 2) {
            diff += totalCards;
        }
        return diff;
    }

    goToSlide(index) {
        if (this.isTransitioning || index === this.currentIndex) return;
        this.isTransitioning = true;
        this.currentIndex = index;
        this.updateDisplay();
        setTimeout(() => {
            this.isTransitioning = false;
        }, 400);
    }

    next() {
        this.currentIndex = (this.currentIndex + 1) % this.users.length;
        this.updateDisplay();
    }

    prev() {
        this.currentIndex = (this.currentIndex - 1 + this.users.length) % this.users.length;
        this.updateDisplay();
    }

    bindEvents() {
        document.getElementById('nextBtn').addEventListener('click', () => this.next());
        document.getElementById('prevBtn').addEventListener('click', () => this.prev());
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('carouselView').classList.contains('active')) {
                if (e.key === 'ArrowRight') this.next();
                if (e.key === 'ArrowLeft') this.prev();
            }
        });
    }
}

// Toggle entre views
class ViewToggle {
    constructor() {
        this.currentView = 'carousel';
        this.init();
    }

    init() {
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        toggleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const viewType = btn.dataset.view;
                this.switchView(viewType);
                toggleButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    }

    switchView(viewType) {
        const gridView = document.getElementById('gridView');
        const carouselView = document.getElementById('carouselView');
        if (viewType === 'grid') {
            gridView.classList.add('active');
            carouselView.classList.remove('active');
            this.currentView = 'grid';
        } else {
            carouselView.classList.add('active');
            gridView.classList.remove('active');
            this.currentView = 'carousel';
        }
    }
}

// Spinner CSS
const style = document.createElement('style');
style.innerHTML = `
.loading-spinner {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(30,30,30,0.8);
  border-radius: 12px;
  padding: 24px 32px;
}

.cinza {
  background: #222 !important;
  color: #aaa !important;
  border-color: #333 !important;
  opacity: 1 !important;
}

.cinza::placeholder {
  color: #333 !important;
}

.spinner-center {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.spinner {
  width: 48px;
  height: 48px;
  border: 6px solid #ccc;
  border-top: 6px solid #4e8cff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);

async function atualizarMarqueeUltimoUsuario() {
  const lastUpdateRef = doc(db, "lastupdate", "latestUser");
  const docSnap = await getDoc(lastUpdateRef);
  const marquee = document.querySelector(".marquee");
  if (!marquee) return;
  if (docSnap.exists()) {
    const data = docSnap.data();
    const nomeUsuario = data.username || "Usu√°rio";
    marquee.textContent = `${nomeUsuario} acabou de entrar no RealMe!`;
  } else {
    marquee.textContent = "Bem-vindo ao RealMe!";
  }
}

document.addEventListener('DOMContentLoaded', atualizarMarqueeUltimoUsuario);


</script>

<script src="./src/js/search.js"></script>
<script src="./block.js"></script>
<script type="module" src="./src/js/search.js"></script>
<script src="./src/js/more.js"></script>
<script type="module" src="./src/js/loading.js"></script>
<script type="module" src="./src/js/navbar.js" defer></script>
</body>
</html>